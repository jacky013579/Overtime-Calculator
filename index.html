<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>搶修工時計算器</title>
    <style>
        /* == 基礎樣式 (Mobile-First) == */
        body { font-family: 'Inter', 'Microsoft JhengHei', sans-serif; background-color: #f0f2f5; padding: 10px; transition: background-color 0.3s; }
        .container { 
            position: relative;
            max-width: 500px; 
            margin: 20px auto; 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            transition: background 0.3s, box-shadow 0.3s;
        }
        h2 { text-align: center; color: #333; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; transition: color 0.3s, border-color 0.3s; }
        
        /* 時制切換按鈕樣式 */
        #format-toggle {
            position: absolute;
            top: 20px; 
            right: 15px; 
            padding: 6px 10px; 
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f8f9fa;
            cursor: pointer;
            font-size: 13px; 
            font-weight: bold;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
            z-index: 10;
        }
        #format-toggle:hover {
            background-color: #e2e6ea;
        }

        .section { margin-bottom: 30px; padding: 15px; background: #fff; border: 1px solid #ddd; border-radius: 10px; position: relative; transition: background 0.3s, border-color 0.3s; }
        
        /* 區塊標題樣式 */
        .section-title { 
            font-size: 1.2em; 
            font-weight: bold; 
            margin-bottom: 15px; 
            display: block; 
        }
        
        /* 輸入欄位通用樣式 */
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; transition: color 0.3s; }
        input[type="tel"], input[type="number"] { 
            width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; font-size: 18px; box-sizing: border-box;
            text-align: center; background-color: white; color: #333; transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        input[type="tel"]::placeholder {
            color: #aaa;
            font-style: italic;
        }
        
        /* 按鈕樣式 */
        .action-bar { text-align: right; margin-bottom: 15px; margin-top: -10px; }
        button { 
            padding: 10px 15px; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; font-weight: bold; 
            transition: background 0.3s, box-shadow 0.3s; display: inline-block; width: auto; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-blue { background-color: #dc3545; color: white; }
        .btn-green { background-color: #17a2b8; color: white; }
        .btn-blue:hover { background-color: #bd2130; box-shadow: 0 4px 6px rgba(0,0,0,0.15); }
        .btn-green:hover { background-color: #138496; box-shadow: 0 4px 6px rgba(0,0,0,0.15); }

        .result-area { margin-top: 15px; padding: 15px; border-radius: 8px; display: none; text-align: center; transition: background-color 0.3s, border-color 0.3s; }
        .ot-result-area { background-color: #e6f7ff; border: 1px solid #91d5ff; }
        .leave-result-area { background-color: #fff3cd; border: 1px solid #ffeeba; }
        
        .result-detail { text-align: left; font-size: 16px; line-height: 1.6; color: #333; transition: color 0.3s; }
        .highlight-range { color: #dc3545; font-weight: bold; font-size: 1.6em; }
        .highlight-pay { color: #007bff; font-weight: bold; font-size: 1.2em; }
        .highlight-comp { color: #28a745; font-weight: bold; font-size: 1.2em; }
        
        /* 超時警示樣式 */
        .alert-red { color: #dc3545; font-weight: bold; font-size: 0.9em; margin-left: 10px; }


        /* ==================================== */
        /* 深色模式 (DARK MODE)       */
        /* ==================================== */
        body.dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }
        body.dark-mode .container {
            background: #1f1f1f;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        body.dark-mode h2 {
            color: #ffffff;
            border-bottom: 2px solid #333;
        }
        body.dark-mode p {
            color: #ccc;
        }
        body.dark-mode label {
            color: #bbb;
        }
        body.dark-mode input[type="tel"], 
        body.dark-mode input[type="number"] {
            background-color: #2c2c2c;
            color: #e0e0e0;
            border: 1px solid #444;
        }
        body.dark-mode input[type="tel"]::placeholder {
            color: #888;
        }
        body.dark-mode .section {
            background: #1f1f1f;
            border: 1px solid #333;
        }
        body.dark-mode .ot-result-area { 
            background-color: #2a353d; /* 深藍色背景 */
            border: 1px solid #45677d; 
        }
        body.dark-mode .leave-result-area { 
            background-color: #3b3a2a; /* 深黃色背景 */
            border: 1px solid #6b6a4f; 
        }
        body.dark-mode .result-detail {
            color: #e0e0e0; /* 結果區文字顏色 */
        }
        body.dark-mode #format-toggle {
            background-color: #333;
            color: #fff;
            border: 1px solid #555;
        }
        body.dark-mode #format-toggle:hover {
            background-color: #444;
        }

        /* == 響應式佈局 (Media Query for Desktop) == */
        @media (min-width: 768px) {
            .container { max-width: 700px; }
            .input-group { display: flex; gap: 20px; align-items: flex-start; }
            .input-item { flex-grow: 1; width: 50%; }
            .input-item label, .input-item input { width: 100%; }
            .action-bar { margin-top: 5px; } 
            #format-toggle { top: 30px; }
        }
    </style>
</head>
<body>

<div class="container">
    <button id="format-toggle" onclick="toggleTimeFormat()">切換時制</button>

    <h2>⚡ 搶修工時計算器</h2>
    <p style="text-align: center; font-size: 14px; color: #888;">增加暗黑模式！</p>

    <!-- 1. 加班與補休計算 -->
    <div class="section">
        <span class="section-title" style="color: #17a2b8;">
            1. 加班與補休計算
        </span>
        <div class="action-bar">
            <button onclick="runOT()" class="btn-green">計算時數</button>
        </div>
        <div class="input-group">
            <div class="input-item">
                <label>加班開始時間：</label>
                <input type="tel" id="otStart" placeholder="例如 9:30 或 930" onblur="handleTimeInputFormatting(this)">
            </div>
            <div class="input-item">
                <label>加班結束時間：</label>
                <input type="tel" id="otEnd" placeholder="例如 9:30 或 930" onblur="handleTimeInputFormatting(this)">
            </div>
        </div>

        <div id="otRes" class="result-area ot-result-area">
            <div class="result-detail">
                實際總時長：
                <span id="txtTime" style="font-weight: bold;">0 小時 0 分</span>
                <span id="alert12Hours" class="alert-red" style="display: none;"> (已超過 12 小時，請注意!)</span>
                <br>
                實際夜間工時 (23:00-07:00)：<span id="txtNightTime" style="font-weight: bold;">0 小時 0 分</span>
                <hr style="opacity: 0.3; margin: 10px 0;">
                <div style="text-align: center;">
                    加班申報：<b class="highlight-pay" id="txtPay">0</b> 小時<br>
                    補休時數：<b class="highlight-comp" id="txtComp">0</b> 小時
                </div>
            </div>
        </div>
    </div>

    <!-- 2. 預估下班時間範圍 (預設展開) -->
    <div class="section">
        <span class="section-title" style="color: #dc3545;">
            2. 預估下班時間範圍
        </span>

        <div id="leaveSectionContent" class="leave-section-content">
            <div class="action-bar">
                <button onclick="runLeave()" class="btn-blue">計算預估範圍</button>
            </div>
            <div class="input-group">
                <div class="input-item">
                    <label>上班打卡時間：</label>
                    <input type="tel" id="startTime" placeholder="例如 9:30 或 930" onblur="handleTimeInputFormatting(this)">
                </div>
                <div class="input-item">
                    <label>工作時數 (預設8)：</label>
                    <!-- 已調整：使用 inputmode="decimal" 確保行動裝置顯示數字鍵盤且支援小數點 -->
                    <input type="number" id="workHours" value="8" step="0.5" inputmode="decimal">
                </div>
            </div>
            
            <div id="leaveRes" class="result-area leave-result-area">
                預估下班時間範圍：
                <div class="highlight-range" id="leaveTimeDisplay">--:-- - --:--</div>
            </div>
        </div>
    </div>
</div>

<script>
// === 全域變數與 Cookie 處理 ===
let timeFormatPreference = '24h'; // 預設 24h

/**
 * 設置 Cookie
 */
function setCookie(name, value, days) {
    let expires = "";
    if (days) {
        let date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        expires = "; expires=" + date.toUTCString();
    }
    document.cookie = name + "=" + (value || "") + expires + "; path=/";
}

/**
 * 獲取 Cookie
 */
function getCookie(name) {
    let nameEQ = name + "=";
    let ca = document.cookie.split(';');
    for(let i=0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
}

/**
 * 將 Date 物件轉換為指定時制格式的字串 (用於顯示結果)
 * @param {Date} date - Date 物件
 * @param {string} format - '24h' 或 '12h'
 * @returns {string} 格式化後的時間字串
 */
function formatTime(date, format) {
    let h = date.getHours();
    let m = date.getMinutes().toString().padStart(2, '0');
    
    if (format === '12h') {
        const ampm = h >= 12 ? ' PM' : ' AM';
        h = h % 12;
        h = h ? h : 12; // 0點顯示為12點
        h = h.toString();
        return `${h}:${m}${ampm}`;
    } else { // 24h format
        h = h.toString().padStart(2, '0');
        return `${h}:${m}`;
    }
}

/**
 * 解析使用者輸入的時間字串，支援 24H 和 12H (AM/PM) 格式。
 * @param {string} timeString - 使用者輸入的時間字串 (e.g., "9:00", "15:30", "3:30 PM")
 * @returns {string|null} 24小時制 'HH:MM' 格式字串，或 null 如果解析失敗。
 */
function parseInputTime(timeString) {
    if (!timeString) return null;
    timeString = timeString.trim().toUpperCase();
    
    // 1. 嘗試匹配 24H 格式 (HH:MM or H:MM)
    let match24 = timeString.match(/^(\d{1,2}):(\d{2})$/);
    if (match24) {
        let h = parseInt(match24[1], 10);
        let m = parseInt(match24[2], 10);
        if (h >= 0 && h <= 23 && m >= 0 && m <= 59) {
            return h.toString().padStart(2, '0') + ':' + m.toString().padStart(2, '0');
        }
    }

    // 2. 嘗試匹配 12H 格式 (H:MM AM/PM)
    let match12 = timeString.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/);
    if (match12) {
        let h = parseInt(match12[1], 10);
        let m = parseInt(match12[2], 10);
        let ampm = match12[3];

        if (h < 1 || h > 12 || m < 0 || m > 59) return null;

        if (ampm === 'PM' && h !== 12) {
            h += 12;
        } else if (ampm === 'AM' && h === 12) {
            h = 0; // 12:xx AM is midnight (00:xx)
        }
        
        return h.toString().padStart(2, '0') + ':' + m.toString().padStart(2, '0');
    }

    // 3. 嘗試匹配純數字格式 (例如 930 -> 09:30)
    let digits = timeString.replace(/\D/g, ''); 
    if (digits.length >= 3 && digits.length <= 4) {
        let h, m;
        if (digits.length === 3) {
            h = parseInt(digits.slice(0, 1), 10);
            m = parseInt(digits.slice(1, 3), 10);
        } else { // 4 digits
            h = parseInt(digits.slice(0, 2), 10);
            m = parseInt(digits.slice(2, 4), 10);
        }

        if (h >= 0 && h <= 23 && m >= 0 && m <= 59) {
            return h.toString().padStart(2, '0') + ':' + m.toString().padStart(2, '0');
        }
    }


    return null; // 解析失敗
}

/**
 * 自動格式化數字時間輸入 (例如 23 -> 23:00, 1243 -> 12:43)
 * 此函式在 onblur (失去焦點) 時觸發。
 * @param {HTMLInputElement} inputElement - 欄位元素
 */
function handleTimeInputFormatting(inputElement) {
    let rawValue = inputElement.value.trim();
    if (!rawValue) return;

    // 如果已經包含標準時間符號 (冒號、AM/PM)，則不做自動數字格式化
    if (rawValue.includes(':') || rawValue.toUpperCase().includes('AM') || rawValue.toUpperCase().includes('PM')) {
        return;
    }
    
    // 僅保留數字
    let digits = rawValue.replace(/\D/g, ''); 
    let formattedTime = '';

    if (digits.length === 0) {
        return;
    } else if (digits.length <= 2) {
        // 1 或 2 位數: 視為小時，補零後加 ':00'。例如 9 -> 09:00, 23 -> 23:00
        formattedTime = digits.padStart(2, '0') + ':00';
    } else if (digits.length === 3) {
        // 3 位數: 視為 HMM，例如 730 -> 07:30
        formattedTime = digits.slice(0, 1).padStart(2, '0') + ':' + digits.slice(1);
    } else if (digits.length >= 4) {
        // 4 位數或以上: 視為 HHMM，例如 1243 -> 12:43 (取前四位)
        formattedTime = digits.slice(0, 2) + ':' + digits.slice(2, 4);
    } else {
        return;
    }

    // 檢查格式化後的時間是否有效 (00:00 - 23:59)
    const [hStr, mStr] = formattedTime.split(':');
    const h = parseInt(hStr, 10);
    const m = parseInt(mStr, 10);

    if (h >= 0 && h <= 23 && m >= 0 && m <= 59) {
        // 有效時間，更新輸入欄位的值
        inputElement.value = formattedTime;
    } else {
        // 無效時間 (例如 25:00 或 12:65)
        // 保持原始輸入，讓 parseInputTime 在計算時報錯
        console.warn(`無效的時間輸入，已跳過格式化: ${rawValue}`);
    }
}


// === UI 與時制切換邏輯 ===

/**
 * 載入時制偏好並設定初始狀態
 */
function loadTimeFormatPreference() {
    const savedFormat = getCookie('timeFormat');
    if (savedFormat) {
        timeFormatPreference = savedFormat;
    }
    updateToggleButtonText();
}

/**
 * 更新按鈕文字 (縮短文字以優化手機版)
 */
function updateToggleButtonText() {
    const toggleButton = document.getElementById('format-toggle');
    if (timeFormatPreference === '24h') {
        toggleButton.innerText = '切換 12H';
    } else { // 12h
        toggleButton.innerText = '切換 24H';
    }
}

/**
 * 切換時制並儲存偏好
 */
function toggleTimeFormat() {
    timeFormatPreference = (timeFormatPreference === '24h') ? '12h' : '24h';
    setCookie('timeFormat', timeFormatPreference, 365); // 儲存 365 天
    updateToggleButtonText();
    
    // 重新計算並更新現有結果，以切換顯示格式
    const leaveRes = document.getElementById('leaveRes');
    const otRes = document.getElementById('otRes');
    
    // 如果結果區塊是顯示狀態，則重新計算以更新格式
    if (leaveRes.style.display === 'block') {
        runLeave(); 
    }
    if (otRes.style.display === 'block') {
        runOT(false); // 重新跑OT計算，但不顯示alert
    }
    
    console.log(`時制已切換為 ${timeFormatPreference}。`);
}


// === 自動深色模式邏輯 (Auto Dark Mode Logic) ===

/**
 * 檢查當前時間是否在夜間 (18:00 到 06:00)
 * @returns {boolean}
 */
function isNightTime() {
    const now = new Date();
    const hour = now.getHours();
    // 夜間定義：18:00 (含) 到 06:00 (不含)
    return hour >= 18 || hour < 6;
}

/**
 * 檢查系統是否偏好深色模式
 * @returns {boolean}
 */
function isSystemDarkModePreferred() {
    return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
}

/**
 * 根據時間和設備偏好自動應用主題
 */
function applyAutomaticTheme() {
    const body = document.body;
    // 如果是夜間 *或* 系統偏好深色模式，則啟用深色模式
    const shouldBeDarkMode = isNightTime() || isSystemDarkModePreferred();
    
    if (shouldBeDarkMode) {
        body.classList.add('dark-mode');
    } else {
        body.classList.remove('dark-mode');
    }
}

// 監聽系統主題變化 (如果有支援)
if (window.matchMedia) {
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyAutomaticTheme);
}


// === 頁面載入時執行所有初始化 ===

window.onload = function() {
    // 1. 載入時間格式偏好
    loadTimeFormatPreference(); 
    // 2. 應用自動深色模式
    applyAutomaticTheme();      
};


// === 1. 加班與補休計算 (runOT) ===

/**
 * 計算兩個時間區間的交集分鐘數
 * @param {Date} aStart - 實際工作的開始時間
 * @param {Date} aEnd - 實際工作的結束時間
 * @param {Date} bStart - 夜間時段的開始時間
 * @param {Date} bEnd - 夜間時段的結束時間
 */
function getIntersectionMins(aStart, aEnd, bStart, bEnd) {
    const intersectionStart = new Date(Math.max(aStart.getTime(), bStart.getTime()));
    const intersectionEnd = new Date(Math.min(aEnd.getTime(), bEnd.getTime()));

    if (intersectionStart >= intersectionEnd) return 0;
    return (intersectionEnd - intersectionStart) / 60000;
}

function runOT(showAlert = true) {
    let inputStart = document.getElementById('otStart').value;
    let inputEnd = document.getElementById('otEnd').value;
    
    const alertElement = document.getElementById('alert12Hours');
    
    let start24h = parseInputTime(inputStart);
    let end24h = parseInputTime(inputEnd);

    alertElement.style.display = 'none';

    if(!start24h || !end24h) {
        document.getElementById('otRes').style.display = 'none';
        if (showAlert) {
            console.error('請輸入完整的開始與結束時間，並確保格式正確 (例如：18:30 或 6:30 PM)');
        }
        return;
    }

    let d1 = new Date('2000-01-01T' + start24h);
    let d2 = new Date('2000-01-01T' + end24h);
    
    // 處理跨日情況 (結束時間早於開始時間，則視為隔日)
    if(d2 <= d1) d2.setDate(d2.getDate() + 1); 

    let diffMins = (d2 - d1) / 60000;
    if(diffMins <= 0) {
        document.getElementById('otRes').style.display = 'none';
        if (showAlert) {
            console.error('結束時間需晚於開始時間');
        }
        return;
    }

    let realHours = diffMins / 60;

    // 12 小時超時警示邏輯
    if (diffMins > 720) {
        alertElement.style.display = 'inline';
    } else {
        alertElement.style.display = 'none';
    }


    // 加班申報時數規則：未滿 2 小時以 2 小時計算，超過 2 小時以小數點無條件進位
    let finalPay = (realHours <= 2) ? 2 : Math.ceil(realHours);
    
    
    // --- 補休時數計算 (23:00 - 07:00 時段) ---
    
    let totalNightMins = 0;
    
    let workStart = new Date('2000-01-01T' + start24h);
    let workEnd = new Date('2000-01-01T' + end24h);
    if(workEnd <= workStart) workEnd.setDate(workEnd.getDate() + 1); // 處理跨日

    // 1. 處理當日 23:00 - 24:00 (如果 workStart 在 23:00 之前)
    let night_pm_start = new Date(workStart); night_pm_start.setHours(23, 0, 0, 0);
    let night_pm_end = new Date(workStart); night_pm_end.setDate(night_pm_end.getDate() + 1); night_pm_end.setHours(0, 0, 0, 0);
    totalNightMins += getIntersectionMins(workStart, workEnd, night_pm_start, night_pm_end);

    // 2. 處理隔日 00:00 - 07:00
    let night_am_start = new Date(workStart); night_am_start.setDate(night_am_start.getDate() + 1); night_am_start.setHours(0, 0, 0, 0);
    let night_am_end = new Date(night_am_start); night_am_end.setHours(7, 0, 0, 0);
    totalNightMins += getIntersectionMins(workStart, workEnd, night_am_start, night_am_end);

    // 3. 處理純當日 00:00 - 07:00 (例如 02:00-05:00)
    // 檢查工作是否在同一天，並且開始時間在 07:00 前
    if (workStart.getHours() < 7 && workEnd.getDate() === workStart.getDate()) {
        let day_early_start = new Date(workStart); day_early_start.setHours(0, 0, 0, 0);
        let day_early_end = new Date(day_early_start); day_early_end.setHours(7, 0, 0, 0);
        
        // 如果是純當日凌晨工作，則以該區間計算
        totalNightMins = getIntersectionMins(workStart, workEnd, day_early_start, day_early_end);
    }
    
    let nightWorkMins = totalNightMins;
    
    // 避免夜間工時超過實際工時
    if (nightWorkMins > diffMins) nightWorkMins = diffMins;
    
    let nightWorkHours = nightWorkMins / 60;

    // 補休規則：未滿 2 小時以 2 小時計算，超過 2 小時以 2 小時為單位無條件進位，上限 8 小時
    let finalComp = 0;
    if (nightWorkHours > 0) {
        // 先計算向上取整到 2 的倍數 (例如 3小時 -> 4小時, 5小時 -> 6小時)
        let roundedHours = Math.ceil(nightWorkHours / 2) * 2;
        // 再限制上限為 8 小時
        finalComp = Math.min(roundedHours, 8);
    }
    
    // 輸出格式化
    let displayH = Math.floor(diffMins / 60);
    let displayM = diffMins % 60;
    let nightDisplayH = Math.floor(nightWorkMins / 60);
    let nightDisplayM = Math.round(nightWorkMins % 60); // 四捨五入分鐘

    document.getElementById('otRes').style.display = 'block';
    document.getElementById('txtTime').innerText = `${displayH} 小時 ${displayM} 分`;
    document.getElementById('txtNightTime').innerText = `${nightDisplayH} 小時 ${nightDisplayM} 分`;
    document.getElementById('txtPay').innerText = finalPay;
    document.getElementById('txtComp').innerText = finalComp;
}


// === 2. 預估下班時間範圍 (runLeave) ===

function runLeave() {
    let inputTime = document.getElementById('startTime').value;
    let hrs = parseFloat(document.getElementById('workHours').value);
    
    // 解析使用者輸入的時間
    let start24h = parseInputTime(inputTime);

    if(!start24h || !hrs) {
        document.getElementById('leaveRes').style.display = 'block';
        document.getElementById('leaveTimeDisplay').innerHTML = '<span style="font-size:18px; color:red;">請輸入正確的時間格式或工作時數！</span>';
        return;
    }
    
    // 使用解析後的 24H 格式時間進行計算
    let originalDate = new Date('2000-01-01T' + start24h);
    
    // 1. 計算最晚下班時間 (加上工時)
    let d_latest = new Date('2000-01-01T' + start24h);
    d_latest.setMinutes(d_latest.getMinutes() + hrs * 60);
    let T_latest_str = formatTime(d_latest, timeFormatPreference);

    // 2. 計算最早下班時間 (減去 59 分鐘，因為打卡時間到 T_latest_str 之間)
    let d_earliest = new Date(d_latest);
    d_earliest.setMinutes(d_earliest.getMinutes() - 59);
    let T_earliest_str = formatTime(d_earliest, timeFormatPreference);
    
    let nextDay = (d_latest.getDate() > originalDate.getDate()) ? '<span style="font-size:14px; color:gray;">(隔日) </span>' : '';
    
    document.getElementById('leaveRes').style.display = 'block';
    document.getElementById('leaveTimeDisplay').innerHTML = `${nextDay}${T_earliest_str} - ${T_latest_str}`;
}
</script>
</body>
</html>

