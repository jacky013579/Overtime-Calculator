<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¶ä¿®å·¥æ™‚è¨ˆç®—å™¨</title>
    <style>
        /* == Base Styles == */
        :root {
            --primary-blue: #007bff;
            --primary-red: #dc3545;
            --primary-green: #28a745;
            --bg-light: #f0f2f5;
            --card-bg: #ffffff;
            --text-main: #333333;
            --text-muted: #666666;
            --border-color: #dddddd;
        }

        body { 
            font-family: 'Inter', 'Microsoft JhengHei', sans-serif; 
            background-color: var(--bg-light); 
            padding: 10px; 
            margin: 0;
            color: var(--text-main);
            transition: background-color 0.3s, color 0.3s; 
        }

        .container { 
            position: relative;
            max-width: 500px; 
            margin: 10px auto; 
            background: var(--card-bg); 
            padding: 20px; 
            border-radius: 16px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
            transition: background 0.3s;
        }

        h2 { text-align: center; margin-bottom: 10px; font-size: 1.5rem; }
        .subtitle { text-align: center; font-size: 13px; color: var(--text-muted); margin-bottom: 20px; line-height: 1.5; }

        #format-toggle {
            position: absolute;
            top: 15px; 
            right: 15px; 
            padding: 6px 12px; 
            border: 1px solid var(--border-color);
            border-radius: 20px;
            background-color: var(--card-bg);
            cursor: pointer;
            font-size: 12px; 
            font-weight: bold;
            z-index: 10;
        }

        .section { 
            margin-bottom: 20px; 
            padding: 15px; 
            background: var(--card-bg); 
            border: 1px solid var(--border-color); 
            border-radius: 12px; 
            position: relative; 
        }

        .section-title { 
            font-size: 1.1rem; 
            font-weight: bold; 
            margin-bottom: 15px; 
            display: flex;
            align-items: center;
            gap: 8px;
        }

        label { display: block; margin-bottom: 6px; font-size: 14px; font-weight: 600; color: var(--text-muted); }
        input[type="tel"], input[type="number"] { 
            width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #eee; border-radius: 10px; font-size: 18px; box-sizing: border-box;
            text-align: center; background-color: #fafafa; color: var(--text-main); transition: border-color 0.2s;
        }
        input:focus { outline: none; border-color: var(--primary-blue); background-color: #fff; }

        .result-area { margin-top: 15px; padding: 15px; border-radius: 10px; display: none; text-align: center; border: 1px solid transparent; }
        .ot-result-area { background-color: #e6f7ff; border-color: #91d5ff; }
        .leave-result-area { background-color: #fffbe6; border-color: #ffe58f; }
        
        .result-detail { text-align: left; font-size: 15px; line-height: 1.8; }
        .highlight-range { color: var(--primary-red); font-weight: 800; font-size: 1.6rem; margin: 5px 0; }
        .highlight-pay { color: #0056b3; font-weight: bold; font-size: 1.2em; }
        .highlight-comp { color: #1e7e34; font-weight: bold; font-size: 1.2em; }
        
        .alert-red { color: var(--primary-red); font-weight: bold; display: block; margin-top: 5px; font-size: 13px; }
        .elapsed-time { font-size: 1rem; font-weight: bold; color: #17a2b8; margin: 10px 0; padding: 8px; background: rgba(23, 162, 184, 0.1); border-radius: 8px; }

        .cutoff-display { color: var(--primary-blue); font-weight: bold; font-size: 0.9em; margin-top: 8px; }

        /* == Dark Mode == */
        body.dark-mode {
            --bg-light: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #aaaaaa;
            --border-color: #333333;
        }
        body.dark-mode input { background-color: #252525; border-color: #444; }
        body.dark-mode .ot-result-area { background-color: #1a2733; border-color: #2c475c; }
        body.dark-mode .leave-result-area { background-color: #2b2a1a; border-color: #5c5a2c; }

        @media (min-width: 768px) {
            .container { max-width: 600px; margin-top: 40px; }
            .input-group { display: flex; gap: 15px; }
            .input-item { flex: 1; }
        }
    </style>
</head>
<body>

<div class="container">
    <button id="format-toggle" onclick="toggleTimeFormat()">24H</button>

    <h2>âš¡ æ¶ä¿®å·¥æ™‚è¨ˆç®—å™¨</h2>
    <div class="subtitle">
        åŠ ç­ï¼šæœªæ»¿ 2H ç®— 2Hï¼Œé€¾ 2H æ¡æ•´æ•¸é€²ä½ã€‚<br>
        è£œä¼‘ (23-07)ï¼šæŒ‰ 2 / 4 / 6 / 8 å°æ™‚ç´šè·è¨ˆç®—ã€‚
    </div>

    <!-- 1. æ‰‹å‹•è¼¸å…¥è¨ˆç®— -->
    <div class="section">
        <span class="section-title" style="color: #17a2b8;">ğŸ•’ 1. åŠ ç­å·¥æ™‚è¨ˆç®— (æ‰‹å‹•)</span>
        <div class="input-group">
            <div class="input-item">
                <label>é–‹å§‹æ™‚é–“</label>
                <input type="tel" id="otStart" placeholder="09:30" onblur="handleAutoFormat(this); runOT()">
            </div>
            <div class="input-item">
                <label>çµæŸæ™‚é–“</label>
                <input type="tel" id="otEnd" placeholder="17:30" onblur="handleAutoFormat(this); runOT()">
            </div>
        </div>

        <div id="otRes" class="result-area ot-result-area">
            <div class="result-detail">
                å¯¦éš›æ™‚é•·ï¼š<span id="txtTime" style="font-weight: bold;">-</span>
                <span id="alert12Hours" class="alert-red" style="display: none;">âš ï¸ å·²é€£çºŒå·¥ä½œè¶…é 12 å°æ™‚ï¼</span>
                <br>
                å¤œé–“å·¥æ™‚ (23-07)ï¼š<span id="txtNightTime" style="font-weight: bold;">0 å°æ™‚ 0 åˆ†</span>
                <hr style="opacity: 0.1; margin: 10px 0;">
                <div style="text-align: center;">
                    åŠ ç­ç”³å ±ï¼š<b class="highlight-pay" id="txtPay">0</b> å°æ™‚ | 
                    è£œä¼‘æ™‚æ•¸ï¼š<b class="highlight-comp" id="txtComp">0</b> å°æ™‚
                </div>
            </div>
        </div>
    </div>

    <!-- 2. å³æ™‚é ä¼° -->
    <div class="section">
        <span class="section-title" style="color: var(--primary-red);">ğŸ“¡ 2. é ä¼°ä¸‹ç­æ™‚é–“ (å³æ™‚)</span>
        <div class="input-group">
            <div class="input-item" style="flex: 2;">
                <label>ä¸Šç­æ‰“å¡æ™‚é–“</label>
                <input type="tel" id="startTime" placeholder="å¦‚ 07:30" onblur="handleAutoFormat(this); updateFloatingWork()">
            </div>
            <div class="input-item" style="flex: 1;">
                <label>ç›®å‰ç”³å ±</label>
                <input type="number" id="workHours" value="0" readonly>
            </div>
        </div>

        <div id="elapsedTimeDisplay" class="elapsed-time" style="text-align: center; display: none;">
            ç›®å‰å·²å·¥ä½œï¼š<span id="currentElapsed">0 å°æ™‚ 0 åˆ†</span>
        </div>

        <div id="leaveRes" class="result-area leave-result-area">
            <div style="font-weight: bold; margin-bottom: 5px;">
                é ä¼°ç”³å ±ï¼š<span class="highlight-pay" id="estPay">0</span> H / è£œä¼‘ï¼š<span class="highlight-comp" id="estComp">0</span> H
            </div>
            å»ºè­°ä¸‹ç­å€é–“ï¼š
            <div class="highlight-range" id="leaveTimeRange">--:--</div>
            <div class="cutoff-display" id="cutoffMsg"></div>
        </div>
    </div>
</div>

<script>
let timeFormat = '24h';

// --- å·¥å…·å‡½æ•¸ ---
function setCookie(n, v) { document.cookie = `${n}=${v};path=/;max-age=31536000`; }
function getCookie(n) {
    let match = document.cookie.match(new RegExp('(^| )' + n + '=([^;]+)'));
    return match ? match[2] : null;
}

function handleAutoFormat(el) {
    let val = el.value.replace(/\D/g, '');
    if (val.length >= 3) {
        let h = val.length === 3 ? val.slice(0,1).padStart(2, '0') : val.slice(0,2);
        let m = val.slice(-2);
        if (parseInt(h) < 24 && parseInt(m) < 60) el.value = `${h}:${m}`;
    }
}

function parseTime(str) {
    if (!str) return null;
    let m = str.match(/^(\d{1,2}):(\d{2})$/);
    if (!m) return null;
    return { h: parseInt(m[1]), m: parseInt(m[2]) };
}

function formatDisplayTime(date) {
    let h = date.getHours();
    let m = date.getMinutes().toString().padStart(2, '0');
    if (timeFormat === '12h') {
        let suffix = h >= 12 ? ' PM' : ' AM';
        h = h % 12 || 12;
        return `${h}:${m}${suffix}`;
    }
    return `${h.toString().padStart(2, '0')}:${m}`;
}

// --- æ ¸å¿ƒé‚è¼¯ ---

/**
 * æ›´æ–°å¾Œçš„è£œä¼‘ç´šè·è¨ˆç®—
 * 0 < h <= 2 -> 2H
 * 2 < h <= 4 -> 4H
 * 4 < h <= 6 -> 6H
 * 6 < h      -> 8H
 */
function getNightComp(start, end) {
    let totalMins = (end - start) / 60000;
    let nightMins = 0;
    
    let checkPoints = [
        { s: 0, e: 7, d: 0 },
        { s: 23, e: 24, d: 0 },
        { s: 0, e: 7, d: 1 }
    ];

    checkPoints.forEach(p => {
        let ps = new Date(start); ps.setDate(ps.getDate() + p.d); ps.setHours(p.s, 0, 0, 0);
        let pe = new Date(start); pe.setDate(pe.getDate() + p.d); pe.setHours(p.e, 0, 0, 0);
        let overlap = Math.min(end, pe) - Math.max(start, ps);
        if (overlap > 0) nightMins += overlap / 60000;
    });

    let nh = nightMins / 60;
    let comp = 0;
    
    if (nh > 6) comp = 8;
    else if (nh > 4) comp = 6;
    else if (nh > 2) comp = 4;
    else if (nh > 0) comp = 2;

    return { nightMins, comp };
}

function calculatePayHours(realHours) {
    return realHours <= 2 ? 2 : Math.ceil(realHours);
}

// --- UI æ›´æ–° ---

function toggleTimeFormat() {
    timeFormat = timeFormat === '24h' ? '12h' : '24h';
    document.getElementById('format-toggle').innerText = timeFormat.toUpperCase();
    setCookie('pref_fmt', timeFormat);
    runOT();
    updateFloatingWork();
}

function runOT() {
    let sStr = document.getElementById('otStart').value;
    let eStr = document.getElementById('otEnd').value;
    let s = parseTime(sStr), e = parseTime(eStr);

    if (!s || !e) {
        document.getElementById('otRes').style.display = 'none';
        return;
    }

    let now = new Date();
    let dS = new Date(now.getFullYear(), now.getMonth(), now.getDate(), s.h, s.m);
    let dE = new Date(now.getFullYear(), now.getMonth(), now.getDate(), e.h, e.m);
    if (dE <= dS) dE.setDate(dE.getDate() + 1);

    let diff = (dE - dS) / 60000;
    let { nightMins, comp } = getNightComp(dS, dE);
    
    document.getElementById('otRes').style.display = 'block';
    document.getElementById('txtTime').innerText = `${Math.floor(diff/60)}H ${Math.round(diff%60)}M`;
    document.getElementById('txtNightTime').innerText = `${Math.floor(nightMins/60)}H ${Math.round(nightMins%60)}M`;
    document.getElementById('txtPay').innerText = calculatePayHours(diff/60);
    document.getElementById('txtComp').innerText = comp;
    document.getElementById('alert12Hours').style.display = diff > 720 ? 'block' : 'none';
}

function updateFloatingWork() {
    let sStr = document.getElementById('startTime').value;
    let s = parseTime(sStr);
    if (!s) {
        document.getElementById('leaveRes').style.display = 'none';
        document.getElementById('elapsedTimeDisplay').style.display = 'none';
        return;
    }

    let now = new Date();
    let dS = new Date(now.getFullYear(), now.getMonth(), now.getDate(), s.h, s.m);
    if (dS > now) dS.setDate(dS.getDate() - 1);

    let elapsed = (now - dS) / 60000;
    
    // é€±é–“æˆªæ­¢ (Mon-Fri 08:00)
    let cutoff = null;
    let day = now.getDay();
    if (day >= 1 && day <= 5) {
        cutoff = new Date(dS);
        cutoff.setHours(8, 0, 0, 0);
        if (dS >= cutoff) cutoff.setDate(cutoff.getDate() + 1);
    }

    let isCutoff = cutoff && now > cutoff;
    let calcEnd = isCutoff ? cutoff : now;
    let calcMins = (calcEnd - dS) / 60000;
    
    let pay = calculatePayHours(calcMins / 60);
    let { comp } = getNightComp(dS, calcEnd);

    document.getElementById('workHours').value = pay;
    document.getElementById('estPay').innerText = pay;
    document.getElementById('estComp').innerText = comp;
    document.getElementById('currentElapsed').innerText = `${Math.floor(elapsed/60)} å°æ™‚ ${Math.round(elapsed%60)} åˆ†`;
    document.getElementById('elapsedTimeDisplay').style.display = 'block';
    document.getElementById('leaveRes').style.display = 'block';

    if (isCutoff) {
        document.getElementById('leaveTimeRange').innerHTML = formatDisplayTime(cutoff);
        document.getElementById('cutoffMsg').innerHTML = `âš ï¸ é€±é–“æˆªæ­¢å·²é”æ¨™ (å·¥æ™‚é–å®š)`;
    } else {
        let dLatest = new Date(dS); dLatest.setMinutes(dS.getMinutes() + (pay * 60));
        let dEarliest = new Date(dLatest); dEarliest.setMinutes(dLatest.getMinutes() - 59);
        if (dEarliest < dS) dEarliest = dS;
        
        let prefix = dLatest.getDate() !== dS.getDate() ? '<small>(éš”æ—¥) </small>' : '';
        document.getElementById('leaveTimeRange').innerHTML = `${prefix}${formatDisplayTime(dEarliest)} - ${formatDisplayTime(dLatest)}`;
        document.getElementById('cutoffMsg').innerText = `(å»ºè­°åœ¨æ­¤å€é–“å…§ä¸‹ç­ä»¥ç¬¦åˆç”³å ±)`;
    }
}

// --- åˆå§‹åŒ– ---
window.onload = () => {
    let savedFmt = getCookie('pref_fmt');
    if (savedFmt) {
        timeFormat = savedFmt;
        document.getElementById('format-toggle').innerText = timeFormat.toUpperCase();
    }

    const checkTheme = () => {
        let h = new Date().getHours();
        let isDark = h >= 18 || h < 6 || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
        document.body.classList.toggle('dark-mode', isDark);
    };
    checkTheme();
    setInterval(updateFloatingWork, 30000);
};
</script>
</body>
</html>

