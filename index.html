<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>搶修工時計算器</title>
    <style>
        /* == 基礎樣式 (Mobile-First) == */
        body { font-family: 'Inter', 'Microsoft JhengHei', sans-serif; background-color: #f0f2f5; padding: 10px; transition: background-color 0.3s; }
        .container { 
            position: relative;
            max-width: 500px; 
            margin: 20px auto; 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            transition: background 0.3s, box-shadow 0.3s;
        }
        h2 { text-align: center; color: #333; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; transition: color 0.3s, border-color 0.3s; }
        
        /* 時制切換按鈕樣式 */
        #format-toggle {
            position: absolute;
            top: 20px; 
            right: 15px; 
            padding: 6px 10px; 
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f8f9fa;
            cursor: pointer;
            font-size: 13px; 
            font-weight: bold;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
            z-index: 10;
        }
        #format-toggle:hover {
            background-color: #e2e6ea;
        }

        .section { margin-bottom: 30px; padding: 15px; background: #fff; border: 1px solid #ddd; border-radius: 10px; position: relative; transition: background 0.3s, border-color 0.3s; }
        
        /* 區塊標題樣式 */
        .section-title { 
            font-size: 1.2em; 
            font-weight: bold; 
            margin-bottom: 15px; 
            display: block; 
        }
        
        /* 輸入欄位通用樣式 */
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; transition: color 0.3s; }
        input[type="tel"], input[type="number"] { 
            width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; font-size: 18px; box-sizing: border-box;
            text-align: center; background-color: white; color: #333; transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        input[type="tel"]::placeholder {
            color: #aaa;
            font-style: italic;
        }
        
        /* 按鈕樣式 */
        .action-bar { text-align: right; margin-bottom: 15px; margin-top: -10px; }
        button { 
            padding: 10px 15px; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; font-weight: bold; 
            transition: background 0.3s, box-shadow 0.3s; display: inline-block; width: auto; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-blue { background-color: #dc3545; color: white; }
        .btn-green { background-color: #17a2b8; color: white; }
        .btn-blue:hover { background-color: #bd2130; box-shadow: 0 4px 6px rgba(0,0,0,0.15); }
        .btn-green:hover { background-color: #138496; box-shadow: 0 4px 6px rgba(0,0,0,0.15); }

        .result-area { margin-top: 15px; padding: 15px; border-radius: 8px; display: none; text-align: center; transition: background-color 0.3s, border-color 0.3s; }
        .ot-result-area { background-color: #e6f7ff; border: 1px solid #91d5ff; }
        .leave-result-area { background-color: #fff3cd; border: 1px solid #ffeeba; }
        
        .result-detail { text-align: left; font-size: 16px; line-height: 1.6; color: #333; transition: color 0.3s; }
        .highlight-range { color: #dc3545; font-weight: bold; font-size: 1.4em; }
        .highlight-pay { color: #007bff; font-weight: bold; font-size: 1.2em; }
        .highlight-comp { color: #28a745; font-weight: bold; font-size: 1.2em; }
        
        /* 超時警示樣式 */
        .alert-red { color: #dc3545; font-weight: bold; font-size: 0.9em; margin-left: 10px; }
        .elapsed-time { font-size: 1.1em; font-weight: bold; color: #17a2b8; margin-bottom: 10px; }


        /* ==================================== */
        /* 深色模式 (DARK MODE)       */
        /* ==================================== */
        body.dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }
        body.dark-mode .container {
            background: #1f1f1f;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        body.dark-mode h2 {
            color: #ffffff;
            border-bottom: 2px solid #333;
        }
        body.dark-mode p {
            color: #ccc;
        }
        body.dark-mode label {
            color: #bbb;
        }
        body.dark-mode input[type="tel"], 
        body.dark-mode input[type="number"] {
            background-color: #2c2c2c;
            color: #e0e0e0;
            border: 1px solid #444;
        }
        body.dark-mode input[type="tel"]::placeholder {
            color: #888;
        }
        body.dark-mode .section {
            background: #1f1f1f;
            border: 1px solid #333;
        }
        body.dark-mode .ot-result-area { 
            background-color: #2a353d; /* 深藍色背景 */
            border: 1px solid #45677d; 
        }
        body.dark-mode .leave-result-area { 
            background-color: #3b3a2a; /* 深黃色背景 */
            border: 1px solid #6b6a4f; 
        }
        body.dark-mode .result-detail {
            color: #e0e0e0; /* 結果區文字顏色 */
        }
        body.dark-mode #format-toggle {
            background-color: #333;
            color: #fff;
            border: 1px solid #555;
        }
        body.dark-mode #format-toggle:hover {
            background-color: #444;
        }
        body.dark-mode .elapsed-time {
            color: #4dc3e5; /* 藍綠色 */
        }


        /* == 響應式佈局 (Media Query for Desktop) == */
        @media (min-width: 768px) {
            .container { max-width: 700px; }
            .input-group { display: flex; gap: 20px; align-items: flex-start; }
            .input-item { flex-grow: 1; width: 50%; }
            .input-item label, .input-item input { width: 100%; }
            .action-bar { margin-top: 5px; } 
            #format-toggle { top: 30px; }
        }
    </style>
</head>
<body>

<div class="container">
    <button id="format-toggle" onclick="toggleTimeFormat()">切換時制</button>

    <h2>⚡ 搶修工時計算器</h2>
    <p style="text-align: center; font-size: 14px; color: #888;">
        加班申報規則：未滿 2H 以 2H 計，超過 2H 以整數小時進位。<br>
        補休規則：23:00-07:00 時段，分級計算補休時數。
    </p>

    <!-- 1. 加班與補休計算 (手動輸入區間) -->
    <div class="section">
        <span class="section-title" style="color: #17a2b8;">
            1. 加班與補休計算 (手動區間)
        </span>
        <div class="action-bar">
            <button onclick="runOT()" class="btn-green">計算時數</button>
        </div>
        <div class="input-group">
            <div class="input-item">
                <label>加班開始時間：</label>
                <input type="tel" id="otStart" placeholder="例如 9:30 或 930" onblur="handleTimeInputFormatting(this)">
            </div>
            <div class="input-item">
                <label>加班結束時間：</label>
                <input type="tel" id="otEnd" placeholder="例如 9:30 或 930" onblur="handleTimeInputFormatting(this)">
            </div>
        </div>

        <div id="otRes" class="result-area ot-result-area">
            <div class="result-detail">
                實際總時長：
                <span id="txtTime" style="font-weight: bold;">0 小時 0 分</span>
                <span id="alert12Hours" class="alert-red" style="display: none;"> (已超過 12 小時，請注意!)</span>
                <br>
                實際夜間工時 (23:00-07:00)：<span id="txtNightTime" style="font-weight: bold;">0 小時 0 分</span>
                <hr style="opacity: 0.3; margin: 10px 0;">
                <div style="text-align: center;">
                    加班申報：<b class="highlight-pay" id="txtPay">0</b> 小時<br>
                    補休時數：<b class="highlight-comp" id="txtComp">0</b> 小時
                </div>
            </div>
        </div>
    </div>

    <!-- 2. 預估下班時間範圍 (即時浮動工時) -->
    <div class="section">
        <span class="section-title" style="color: #dc3545;">
            2. 預估下班時間範圍 (參照系統時間)
        </span>

        <div id="leaveSectionContent" class="leave-section-content">
            <div class="input-group">
                <div class="input-item" style="flex-grow: 2;">
                    <label>上班打卡時間：</label>
                    <input type="tel" id="startTime" placeholder="例如 7:30" 
                        onblur="handleTimeInputFormatting(this); updateFloatingWorkState()">
                </div>
                <!-- 這個欄位現在用於顯示計算出的申報工時，但用戶仍可手動調整進行試算 -->
                <div class="input-item" style="flex-grow: 1;">
                    <label>當前申報工時：</label>
                    <input type="number" id="workHours" value="0" step="1" inputmode="decimal" readonly>
                </div>
            </div>

            <!-- 新增顯示目前已工作時長 -->
            <div id="elapsedTimeDisplay" class="elapsed-time" style="text-align: center; display: none;">
                您目前實際工作：<span id="currentElapsed" style="font-size: 1.2em;">0 小時 0 分</span>
            </div>

            <div class="action-bar">
                <button onclick="updateFloatingWorkState()" class="btn-blue">刷新計算</button>
            </div>
            
            <div id="leaveRes" class="result-area leave-result-area">
                預估下班時間範圍：
                <div class="highlight-range" id="leaveTimeDisplay">--:-- - --:--</div>
            </div>
        </div>
    </div>
</div>

<script>
// === 全域變數與 Cookie 處理 ===
let timeFormatPreference = '24h'; // 預設 24h

/**
 * 設置 Cookie
 */
function setCookie(name, value, days) {
    let expires = "";
    if (days) {
        let date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        expires = "; expires=" + date.toUTCString();
    }
    document.cookie = name + "=" + (value || "") + expires + "; path=/";
}

/**
 * 獲取 Cookie
 */
function getCookie(name) {
    let nameEQ = name + "=";
    let ca = document.cookie.split(';');
    for(let i=0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
}

/**
 * 將 Date 物件轉換為指定時制格式的字串 (用於顯示結果)
 * @param {Date} date - Date 物件
 * @param {string} format - '24h' 或 '12h'
 * @returns {string} 格式化後的時間字串
 */
function formatTime(date, format) {
    let h = date.getHours();
    let m = date.getMinutes().toString().padStart(2, '0');
    
    if (format === '12h') {
        const ampm = h >= 12 ? ' PM' : ' AM';
        h = h % 12;
        h = h ? h : 12; // 0點顯示為12點
        h = h.toString();
        return `${h}:${m}${ampm}`;
    } else { // 24h format
        h = h.toString().padStart(2, '0');
        return `${h}:${m}`;
    }
}

/**
 * 解析使用者輸入的時間字串，支援 24H 和 12H (AM/PM) 格式。
 * @param {string} timeString - 使用者輸入的時間字串
 * @returns {string|null} 24小時制 'HH:MM' 格式字串，或 null 如果解析失敗。
 */
function parseInputTime(timeString) {
    if (!timeString) return null;
    timeString = timeString.trim().toUpperCase();
    
    // 1. 嘗試匹配 24H 格式 (HH:MM or H:MM)
    let match24 = timeString.match(/^(\d{1,2}):(\d{2})$/);
    if (match24) {
        let h = parseInt(match24[1], 10);
        let m = parseInt(match24[2], 10);
        if (h >= 0 && h <= 23 && m >= 0 && m <= 59) {
            return h.toString().padStart(2, '0') + ':' + m.toString().padStart(2, '0');
        }
    }

    // 2. 嘗試匹配 12H 格式 (H:MM AM/PM)
    let match12 = timeString.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/);
    if (match12) {
        let h = parseInt(match12[1], 10);
        let m = parseInt(match12[2], 10);
        let ampm = match12[3];

        if (h < 1 || h > 12 || m < 0 || m > 59) return null;

        if (ampm === 'PM' && h !== 12) {
            h += 12;
        } else if (ampm === 'AM' && h === 12) {
            h = 0; // 12:xx AM is midnight (00:xx)
        }
        
        return h.toString().padStart(2, '0') + ':' + m.toString().padStart(2, '0');
    }

    // 3. 嘗試匹配純數字格式 (例如 930 -> 09:30)
    let digits = timeString.replace(/\D/g, ''); 
    if (digits.length >= 3 && digits.length <= 4) {
        let h, m;
        if (digits.length === 3) {
            h = parseInt(digits.slice(0, 1), 10);
            m = parseInt(digits.slice(1, 3), 10);
        } else { // 4 digits
            h = parseInt(digits.slice(0, 2), 10);
            m = parseInt(digits.slice(2, 4), 10);
        }

        if (h >= 0 && h <= 23 && m >= 0 && m <= 59) {
            return h.toString().padStart(2, '0') + ':' + m.toString().padStart(2, '0');
        }
    }


    return null; // 解析失敗
}

/**
 * 自動格式化數字時間輸入
 */
function handleTimeInputFormatting(inputElement) {
    let rawValue = inputElement.value.trim();
    if (!rawValue) return;

    if (rawValue.includes(':') || rawValue.toUpperCase().includes('AM') || rawValue.toUpperCase().includes('PM')) {
        return;
    }
    
    let digits = rawValue.replace(/\D/g, ''); 
    let formattedTime = '';

    if (digits.length === 0) {
        return;
    } else if (digits.length <= 2) {
        formattedTime = digits.padStart(2, '0') + ':00';
    } else if (digits.length === 3) {
        formattedTime = digits.slice(0, 1).padStart(2, '0') + ':' + digits.slice(1);
    } else if (digits.length >= 4) {
        formattedTime = digits.slice(0, 2) + ':' + digits.slice(2, 4);
    } else {
        return;
    }

    const [hStr, mStr] = formattedTime.split(':');
    const h = parseInt(hStr, 10);
    const m = parseInt(mStr, 10);

    if (h >= 0 && h <= 23 && m >= 0 && m <= 59) {
        inputElement.value = formattedTime;
    }
}


// === UI 與時制切換邏輯 ===

function loadTimeFormatPreference() {
    const savedFormat = getCookie('timeFormat');
    if (savedFormat) {
        timeFormatPreference = savedFormat;
    }
    updateToggleButtonText();
}

function updateToggleButtonText() {
    const toggleButton = document.getElementById('format-toggle');
    if (timeFormatPreference === '24h') {
        toggleButton.innerText = '切換 12H';
    } else { 
        toggleButton.innerText = '切換 24H';
    }
}

function toggleTimeFormat() {
    timeFormatPreference = (timeFormatPreference === '24h') ? '12h' : '24h';
    setCookie('timeFormat', timeFormatPreference, 365);
    updateToggleButtonText();
    
    const leaveRes = document.getElementById('leaveRes');
    const otRes = document.getElementById('otRes');
    
    if (leaveRes.style.display === 'block') {
        // 重新計算，確保格式切換
        updateFloatingWorkState(); 
    }
    if (otRes.style.display === 'block') {
        runOT(false); // 重新跑OT計算，更新格式
    }
}

// === 自動深色模式邏輯 ===

function isNightTime() {
    const now = new Date();
    const hour = now.getHours();
    return hour >= 18 || hour < 6;
}

function isSystemDarkModePreferred() {
    return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
}

function applyAutomaticTheme() {
    const body = document.body;
    const shouldBeDarkMode = isNightTime() || isSystemDarkModePreferred();
    
    if (shouldBeDarkMode) {
        body.classList.add('dark-mode');
    } else {
        body.classList.remove('dark-mode');
    }
}

if (window.matchMedia) {
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyAutomaticTheme);
}


// === 1. 加班與補休計算 (runOT) - 適用於手動區間輸入 ===

/**
 * 計算兩個時間區間的交集分鐘數
 */
function getIntersectionMins(aStart, aEnd, bStart, bEnd) {
    const intersectionStart = new Date(Math.max(aStart.getTime(), bStart.getTime()));
    const intersectionEnd = new Date(Math.min(aEnd.getTime(), bEnd.getTime()));

    if (intersectionStart >= intersectionEnd) return 0;
    return (intersectionEnd - intersectionStart) / 60000;
}

/**
 * 根據申報工時規則計算最終申報小時數
 * @param {number} realHours - 實際工作小時數 (含小數)
 * @returns {number} 申報小時數 (整數)
 */
function calculateClaimHours(realHours) {
    let finalPay;
    if (realHours <= 2) {
        finalPay = 2; // 未滿 2 小時，算 2 小時
    } else {
        finalPay = Math.ceil(realHours); // 超過 2 小時，無條件進位到整數小時
    }
    return finalPay;
}

/**
 * 根據新階梯式規則計算夜間補休小時數
 * @param {number} nightWorkHours - 夜間實際工作小時數 (含小數)
 * @returns {number} 補休小時數 (2, 4, 或 8)
 */
function calculateCompHours(nightWorkHours) {
    if (nightWorkHours <= 0) return 0;
    if (nightWorkHours <= 2) return 2;
    if (nightWorkHours <= 4) return 4;
    return 8; // 4 小時以上補休 8 小時
}

function runOT(showAlert = true) {
    let inputStart = document.getElementById('otStart').value;
    let inputEnd = document.getElementById('otEnd').value;
    
    const alertElement = document.getElementById('alert12Hours');
    
    let start24h = parseInputTime(inputStart);
    let end24h = parseInputTime(inputEnd);

    alertElement.style.display = 'none';

    if(!start24h || !end24h) {
        document.getElementById('otRes').style.display = 'none';
        if (showAlert) {
            console.error('請輸入完整的開始與結束時間，並確保格式正確');
        }
        return;
    }

    let d1 = new Date('2000-01-01T' + start24h);
    let d2 = new Date('2000-01-01T' + end24h);
    
    if(d2 <= d1) d2.setDate(d2.getDate() + 1); 

    let diffMins = (d2 - d1) / 60000;
    if(diffMins <= 0) {
        document.getElementById('otRes').style.display = 'none';
        if (showAlert) {
            console.error('結束時間需晚於開始時間');
        }
        return;
    }

    let realHours = diffMins / 60;

    // 12 小時超時警示邏輯
    alertElement.style.display = (diffMins > 720) ? 'inline' : 'none';

    // 申報工時
    let finalPay = calculateClaimHours(realHours);
    
    // 補休時數計算 (23:00 - 07:00 時段)
    let totalNightMins = 0;
    
    let workStart = new Date('2000-01-01T' + start24h);
    let workEnd = new Date('2000-01-01T' + end24h);
    if(workEnd <= workStart) workEnd.setDate(workEnd.getDate() + 1); 

    // 處理夜間時段 (23:00-24:00 + 00:00-07:00)
    // 建立夜間時段的參考時間點 (必須跨日處理)
    const nightPeriods = [
        // 當日 23:00 - 隔日 00:00
        { start: new Date(workStart.getFullYear(), workStart.getMonth(), workStart.getDate(), 23, 0, 0), 
          end: new Date(workStart.getFullYear(), workStart.getMonth(), workStart.getDate() + 1, 0, 0, 0) },
        // 隔日 00:00 - 隔日 07:00
        { start: new Date(workStart.getFullYear(), workStart.getMonth(), workStart.getDate() + 1, 0, 0, 0), 
          end: new Date(workStart.getFullYear(), workStart.getMonth(), workStart.getDate() + 1, 7, 0, 0) }
    ];

    for (const period of nightPeriods) {
        totalNightMins += getIntersectionMins(workStart, workEnd, period.start, period.end);
    }
    
    let nightWorkMins = totalNightMins;
    if (nightWorkMins > diffMins) nightWorkMins = diffMins; // 避免超過實際工時
    
    let nightWorkHours = nightWorkMins / 60;
    let finalComp = calculateCompHours(nightWorkHours);
    
    // 輸出格式化
    let displayH = Math.floor(diffMins / 60);
    let displayM = Math.round(diffMins % 60);
    let nightDisplayH = Math.floor(nightWorkMins / 60);
    let nightDisplayM = Math.round(nightWorkMins % 60); 

    document.getElementById('otRes').style.display = 'block';
    document.getElementById('txtTime').innerText = `${displayH} 小時 ${displayM} 分`;
    document.getElementById('txtNightTime').innerText = `${nightDisplayH} 小時 ${nightDisplayM} 分`;
    document.getElementById('txtPay').innerText = finalPay;
    document.getElementById('txtComp').innerText = finalComp;
}

// === 2. 預估下班時間範圍 (即時浮動工時) ===

/**
 * 處理「上班打卡時間」的 onblur/click 事件，自動計算已工作時長，更新申報工時欄位並觸發計算。
 */
function updateFloatingWorkState() {
    const inputTime = document.getElementById('startTime').value;
    const workHoursInput = document.getElementById('workHours');
    const elapsedDisplay = document.getElementById('elapsedTimeDisplay');
    const currentElapsedSpan = document.getElementById('currentElapsed');
    
    let start24h = parseInputTime(inputTime);

    if (!start24h) {
        elapsedDisplay.style.display = 'none';
        document.getElementById('leaveRes').style.display = 'none';
        workHoursInput.value = 0; 
        return;
    }
    
    // 1. 獲取當前時間 (Now)
    const now = new Date();
    // 2. 為了計算時差，將上班時間設定在當前日期
    let startTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 
                             parseInt(start24h.substring(0, 2), 10), 
                             parseInt(start24h.substring(3, 5), 10), 0);
    
    // 如果上班時間比現在時間還晚，假設它是昨天 (處理跨日情形)
    if (startTime > now) {
        startTime.setDate(startTime.getDate() - 1);
    }
    
    // 3. 計算總共經過的分鐘數 (無休息扣除)
    let elapsedMins = (now - startTime) / 60000;
    
    if (elapsedMins < 0) {
        elapsedDisplay.style.display = 'none';
        document.getElementById('leaveRes').style.display = 'none';
        workHoursInput.value = 0;
        return;
    }

    // 4. 計算實際時數和申報工時
    let realHours = elapsedMins / 60;
    let roundedClaimHours = calculateClaimHours(realHours);

    // 5. 更新顯示
    let elapsedHours = Math.floor(elapsedMins / 60);
    let elapsedMinutes = Math.round(elapsedMins % 60);

    // 更新顯示欄位
    workHoursInput.value = roundedClaimHours; // 設置申報小時數
    currentElapsedSpan.innerText = `${elapsedHours} 小時 ${elapsedMinutes} 分`;
    elapsedDisplay.style.display = 'block';
    
    // 6. 自動執行預估計算
    runLeave(roundedClaimHours);
}

/**
 * 執行預估下班時間範圍計算
 * @param {number} claimHours - 申報工時 (從 updateFloatingWorkState 傳入)
 */
function runLeave(claimHours) {
    let inputTime = document.getElementById('startTime').value;
    // 取得申報工時 (以防用戶手動執行 runLeave)
    let hrs = claimHours || parseFloat(document.getElementById('workHours').value);
    
    let start24h = parseInputTime(inputTime);

    if(!start24h || isNaN(hrs) || hrs <= 0) {
        document.getElementById('leaveRes').style.display = 'block';
        document.getElementById('leaveTimeDisplay').innerHTML = '<span style="font-size:18px; color:red;">請輸入正確的時間格式或申報工時！</span>';
        return;
    }
    
    // 將上班時間設定在任意一個日期
    let originalDate = new Date('2000-01-01T' + start24h);
    
    // 總時長 = 申報工時 (hrs * 60) 分鐘。
    let totalDurationMins = (hrs * 60); 
    
    // 1. 計算最晚下班時間 (加上申報工時)
    let d_latest = new Date('2000-01-01T' + start24h);
    d_latest.setMinutes(d_latest.getMinutes() + totalDurationMins);
    let T_latest_str = formatTime(d_latest, timeFormatPreference);

    // 2. 計算最早下班時間 (減去 59 分鐘，得到範圍的開始點)
    let d_earliest = new Date(d_latest);
    d_earliest.setMinutes(d_earliest.getMinutes() - 59);
    let T_earliest_str = formatTime(d_earliest, timeFormatPreference);
    
    // 檢查是否跨日
    let nextDay = (d_latest.getDate() > originalDate.getDate()) ? '<span style="font-size:14px; color:gray;">(隔日) </span>' : '';
    
    // 輸出格式：[Earliest End Time] - [Latest End Time] (工作 [Rounded Hours] 小時)
    document.getElementById('leaveRes').style.display = 'block';
    document.getElementById('leaveTimeDisplay').innerHTML = `${nextDay}${T_earliest_str} - ${T_latest_str} (工作 ${hrs} 小時)`;
}


// === 頁面載入時執行所有初始化 ===

window.onload = function() {
    loadTimeFormatPreference(); 
    applyAutomaticTheme();      
    
    // 每 30 秒刷新一次，確保即時工時計算貼近當前系統時間
    // 注意：若用戶輸入了打卡時間，則啟用即時刷新
    const startTimeInput = document.getElementById('startTime');
    if (startTimeInput.value) {
        updateFloatingWorkState();
    }

    setInterval(function() {
        const startTimeInput = document.getElementById('startTime');
        if (startTimeInput.value) {
            updateFloatingWorkState();
        }
    }, 30000); // 30 秒
};
</script>
</body>
</html>

