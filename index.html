<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>搶修工時計算器</title>
    <style>
        /* == 基礎樣式 (Mobile-First) == */
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #f0f2f5; padding: 10px; }
        .container { 
            position: relative; /* 為了定位切換按鈕 */
            max-width: 500px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        }
        h2 { text-align: center; color: #333; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        
        /* 時制切換按鈕樣式 */
        #format-toggle {
            position: absolute;
            top: 25px;
            right: 20px;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f8f9fa;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #format-toggle:hover {
            background-color: #e2e6ea;
        }

        .section { margin-bottom: 30px; padding: 15px; background: #fff; border: 1px solid #ddd; border-radius: 10px; }
        .section-title { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; display: block; }
        
        /* 輸入欄位通用樣式 */
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input[type="time"], input[type="number"] { 
            width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; font-size: 18px; box-sizing: border-box;
        }
        
        button { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; font-weight: bold; transition: background 0.3s;}
        .btn-blue { background-color: #dc3545; color: white; }
        .btn-green { background-color: #17a2b8; color: white; }
        .btn-blue:hover { background-color: #bd2130; }
        .btn-green:hover { background-color: #138496; }

        .result-area { margin-top: 15px; padding: 15px; background-color: #fff3cd; border: 1px solid #ffeeba; border-radius: 8px; display: none; text-align: center; }
        .result-detail { text-align: left; font-size: 16px; line-height: 1.6; color: #333; }
        .highlight-range { color: #dc3545; font-weight: bold; font-size: 1.6em; }
        .highlight-pay { color: #007bff; font-weight: bold; font-size: 1.2em; }
        .highlight-comp { color: #28a745; font-weight: bold; font-size: 1.2em; }

        /* == 響應式佈局 (Media Query for Desktop) == */
        @media (min-width: 768px) {
            .container { max-width: 700px; }
            .input-group { display: flex; gap: 20px; align-items: flex-start; }
            .input-item { flex-grow: 1; width: 50%; }
            .input-item label, .input-item input { width: 100%; }
            button { margin-top: 10px; width: 100%; }
            #format-toggle { top: 30px; }
        }
    </style>
</head>
<body>

<div class="container">
    <button id="format-toggle" onclick="toggleTimeFormat()">切換時制</button>

    <h2>⚡ 搶修工時計算器</h2>
    <p style="text-align: center; font-size: 14px; color: #888;">預設 24 小時制，結果格式可切換。</p>

    <div class="section">
        <span class="section-title" style="color: #dc3545;">1. 預估下班時間範圍</span>
        <div class="input-group">
            <div class="input-item">
                <label>上班打卡時間：</label>
                <input type="time" id="startTime">
            </div>
            <div class="input-item">
                <label>工作時數 (預設8)：</label>
                <input type="number" id="workHours" value="8">
            </div>
        </div>
        
        <button onclick="runLeave()" class="btn-blue">計算預估範圍</button>
        
        <div id="leaveRes" class="result-area">
            預估下班時間範圍：
            <div class="highlight-range" id="leaveTimeDisplay">--:-- - --:--</div>
        </div>
    </div>

    <div class="section">
        <span class="section-title" style="color: #17a2b8;">2. 加班與補休計算</span>
        <div class="input-group">
            <div class="input-item">
                <label>加班開始時間：</label>
                <input type="time" id="otStart">
            </div>
            <div class="input-item">
                <label>加班結束時間：</label>
                <input type="time" id="otEnd">
            </div>
        </div>

        <button onclick="runOT()" class="btn-green">計算時數</button>

        <div id="otRes" class="result-area" style="background-color: #e6f7ff; border: 1px solid #91d5ff;">
             <div class="result-detail">
                實際總時長：<span id="txtTime" style="font-weight: bold;"></span><br>
                實際夜間工時 (23:00-07:00)：<span id="txtNightTime" style="font-weight: bold;"></span>
                <hr style="opacity: 0.3; margin: 10px 0;">
                <div style="text-align: center;">
                    加班申報：<b class="highlight-pay" id="txtPay">0</b> 小時<br>
                    補休時數：<b class="highlight-comp" id="txtComp">0</b> 小時
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// === 全域變數與 Cookie 處理 ===
let timeFormatPreference = '24h'; // 預設 24h

/**
 * 設置 Cookie
 * @param {string} name - Cookie 名稱
 * @param {string} value - Cookie 值
 * @param {number} days - 存活天數
 */
function setCookie(name, value, days) {
    let expires = "";
    if (days) {
        let date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        expires = "; expires=" + date.toUTCString();
    }
    document.cookie = name + "=" + (value || "")  + expires + "; path=/";
}

/**
 * 獲取 Cookie
 * @param {string} name - Cookie 名稱
 * @returns {string|null} Cookie 值或 null
 */
function getCookie(name) {
    let nameEQ = name + "=";
    let ca = document.cookie.split(';');
    for(let i=0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
}

/**
 * 將 Date 物件轉換為指定時制格式的字串
 * @param {Date} date - Date 物件
 * @param {string} format - '24h' 或 '12h'
 * @returns {string} 格式化後的時間字串
 */
function formatTime(date, format) {
    let h = date.getHours();
    let m = date.getMinutes().toString().padStart(2, '0');
    
    if (format === '12h') {
        const ampm = h >= 12 ? ' PM' : ' AM';
        h = h % 12;
        h = h ? h : 12; // 0點顯示為12點
        h = h.toString();
        return `${h}:${m}${ampm}`;
    } else { // 24h format
        h = h.toString().padStart(2, '0');
        return `${h}:${m}`;
    }
}

/**
 * 載入時制偏好並設定初始狀態
 */
function loadTimeFormatPreference() {
    const savedFormat = getCookie('timeFormat');
    if (savedFormat) {
        timeFormatPreference = savedFormat;
    }
    updateToggleButtonText();
}

/**
 * 更新按鈕文字
 */
function updateToggleButtonText() {
    const toggleButton = document.getElementById('format-toggle');
    if (timeFormatPreference === '24h') {
        toggleButton.innerText = '切換 12H (AM/PM)';
    } else {
        toggleButton.innerText = '切換 24H';
    }
}

/**
 * 切換時制並儲存偏好
 */
function toggleTimeFormat() {
    timeFormatPreference = (timeFormatPreference === '24h') ? '12h' : '24h';
    setCookie('timeFormat', timeFormatPreference, 365); // 儲存 365 天
    updateToggleButtonText();
    
    // 重新計算並更新現有結果，以切換顯示格式
    const leaveDisplay = document.getElementById('leaveTimeDisplay');
    const otDisplay = document.getElementById('txtPay'); // 檢查OT結果是否已顯示
    
    if (leaveDisplay && leaveDisplay.innerHTML.includes('-')) {
        runLeave(); // 如果下班時間已計算，重新跑一次更新格式
    }
    if (otDisplay && otDisplay.innerText !== '0') {
        runOT(); // 如果加班時間已計算，重新跑一次更新格式
    }
    
    // 注意：瀏覽器的 input[type="time"] 介面樣式由作業系統決定，這裡只能控制輸出格式。
    alert(`時制已切換為 ${timeFormatPreference === '24h' ? '24 小時制' : '12 小時制 (AM/PM)'}，偏好已儲存！`);
}

// 頁面載入時執行
window.onload = loadTimeFormatPreference;


// 1. 計算預估下班時間範圍 (邏輯不變，僅使用新的 formatTime 輸出)
function runLeave() {
    let start = document.getElementById('startTime').value;
    let hrs = parseFloat(document.getElementById('workHours').value);
    
    if(!start || !hrs) {
        document.getElementById('leaveRes').style.display = 'block';
        document.getElementById('leaveTimeDisplay').innerHTML = '<span style="font-size:18px; color:red;">請輸入上班時間與時數！</span>';
        return;
    }
    
    let originalDate = new Date('2000-01-01T' + start);
    
    // 1. 計算最晚下班時間
    let d_latest = new Date('2000-01-01T' + start);
    d_latest.setMinutes(d_latest.getMinutes() + hrs * 60);
    let T_latest_str = formatTime(d_latest, timeFormatPreference);

    // 2. 計算最早下班時間
    let d_earliest = new Date(d_latest);
    d_earliest.setMinutes(d_earliest.getMinutes() - 59);
    let T_earliest_str = formatTime(d_earliest, timeFormatPreference);
    
    let nextDay = (d_latest.getDate() > originalDate.getDate()) ? '<span style="font-size:14px; color:gray;">(隔日) </span>' : '';
    
    document.getElementById('leaveRes').style.display = 'block';
    document.getElementById('leaveTimeDisplay').innerHTML = `${nextDay}${T_earliest_str} - ${T_latest_str}`;
}

// 2. 計算加班與補休 (邏輯不變，僅使用新的 formatTime 輸出)
function runOT() {
    let s = document.getElementById('otStart').value;
    let e = document.getElementById('otEnd').value;
    
    if(!s || !e) {
        document.getElementById('otRes').style.display = 'none';
        return alert('請輸入完整時間');
    }

    let d1 = new Date('2000-01-01T' + s);
    let d2 = new Date('2000-01-01T' + e);
    
    if(d2 < d1) d2.setDate(d2.getDate() + 1); 

    let diffMins = (d2 - d1) / 60000;
    if(diffMins <= 0) return alert('結束時間需晚於開始時間');

    let realHours = diffMins / 60;

    // --- 加班申報時數規則 ---
    let finalPay = (realHours <= 2) ? 2 : Math.ceil(realHours);
    
    // --- 補休時數計算 (僅計算 23:00 - 07:00 時段) ---
    let nightWorkMins = 0;
    let night1Start = new Date(d1); night1Start.setHours(23, 0, 0, 0);
    let night1End = new Date(d1); night1End.setDate(night1End.getDate() + 1); night1End.setHours(0, 0, 0, 0);
    nightWorkMins += getIntersectionMins(d1, d2, night1Start, night1End);

    let night2Start = new Date(d1); night2Start.setDate(night2Start.getDate() + 1); night2Start.setHours(0, 0, 0, 0);
    let night2End = new Date(night2Start); night2End.setHours(7, 0, 0, 0);
    nightWorkMins += getIntersectionMins(d1, d2, night2Start, night2End);
    
    let nightWorkHours = nightWorkMins / 60;

    // 補休規則：2小時級距
    let finalComp = 0;
    if (nightWorkHours > 0) {
        finalComp = (nightWorkHours >= 8) ? 8 : Math.ceil(nightWorkHours / 2) * 2;
    }
    
    // 輸出格式化
    let displayH = Math.floor(diffMins / 60);
    let displayM = diffMins % 60;
    let nightDisplayH = Math.floor(nightWorkMins / 60);
    let nightDisplayM = nightWorkMins % 60;

    document.getElementById('otRes').style.display = 'block';
    document.getElementById('txtTime').innerText = `${displayH} 小時 ${displayM} 分`;
    document.getElementById('txtNightTime').innerText = `${nightDisplayH} 小時 ${nightDisplayM} 分`;
    document.getElementById('txtPay').innerText = finalPay;
    document.getElementById('txtComp').innerText = finalComp;
}
</script>
</body>
</html>
